name: Release MSIX (Auto-Update)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-release-msix:
    runs-on: windows-latest

    env:
      # 1. パッケージプロジェクトのパス
      PACKAGE_PROJECT: 'ClipboardUtilityMSIXInstaller/ClipboardUtilityMSIXInstaller.wapproj'
      # 2. .appinstaller のファイル名
      APPINSTALLER_FILENAME: 'ClipboardUtilityMSIXInstaller.appinstaller'
      # 3. GitHub PagesのベースURL (main/docsから公開)
      APPINSTALLER_URL: 'https://gk-302.github.io/Clipboard-Utility'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            7.0.x
          # MSIXプロジェクトが依存するWPFプロジェクトの復元/ビルドに必要
          workloads: microsoft-net-sdk-windowsdesktop

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Decode PFX Certificate
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "signing_cert.pfx"
          [System.IO.File]::WriteAllBytes($pfxPath, [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}"))
          echo "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      - name: Set Version from Tag
        run: |
          $rawTag = "${{ github.ref_name }}"
          $version = $rawTag.Substring(1) -replace '-.*', ''
          $version = "$version.0"
          echo "PACKAGE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "RELEASE_TAG=$rawTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      - name: Restore solution with dotnet
        run: dotnet restore ClipboardUtility.sln -r win-x86
      - name: Update App Manifest Version
        run: |
          $manifestPath = "${{ github.workspace }}\ClipboardUtilityMSIXInstaller\Package.appxmanifest"
          $version = "${{ env.PACKAGE_VERSION }}"
          
          Write-Host "Updating $manifestPath <Identity Version> to $version"
          
          $xml = [xml](Get-Content $manifestPath)
          # Identity タグの Version 属性を更新
          $xml.Package.Identity.Version = $version
          $xml.Save($manifestPath)
          
          Write-Host "Manifest updated successfully."
        shell: pwsh
      - name: Build MSIX Package
        run: |
          $outputPath = "${{ github.workspace }}\output"
          msbuild ${{ env.PACKAGE_PROJECT }} /p:Configuration=Release `
            /p:AppxPackageDir="$outputPath\" `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="${{ env.PFX_PATH }}" `
            /p:PackageCertificatePassword="${{ secrets.PFX_PASSWORD }}" `
            /p:GenerateAppInstallerFile=true `
            /p:AppInstallerUri="${{ env.APPINSTALLER_URL }}" `
            /p:AppInstallerUpdateFrequency=0 `
            /p:AppInstallerShowPrompt=true `
            /p:ApplicationVersion="${{ env.PACKAGE_VERSION }}" `
            /p:PackageVersion="${{ env.PACKAGE_VERSION }}" `
            /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxBundle=Always `
            /p:AppInstallerMainBundlePath="${{ env.APPINSTALLER_FILENAME }}"
        shell: pwsh

      - name: Get Artifact Names
        run: |
          $searchPath = "${{ github.workspace }}\output"
          Write-Host "Searching for *.msixbundle in $searchPath (recursive)..."
          
          $msixBundle = Get-ChildItem -Path $searchPath -Filter "*.msixbundle" -Recurse | Select-Object -First 1
          
          if ($null -eq $msixBundle) {
            Write-Error "MSIX Bundle (*.msixbundle) not found in $searchPath or its subdirectories."
            exit 1
          }

          Write-Host "Found MSIX Bundle: $($msixBundle.FullName)"
          
          # outputフォルダからの相対パスを取得
          $relativePath = $msixBundle.FullName.Substring($searchPath.Length + 1).Replace('\', '/')
          Write-Host "Relative path: $relativePath"
          
          echo "MSIX_BUNDLE_NAME=$($msixBundle.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "MSIX_BUNDLE_PATH=$($msixBundle.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "MSIX_BUNDLE_RELATIVE_PATH=$relativePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # appinstallerファイルも探す（サブフォルダにある可能性）
          $appInstallerFile = Get-ChildItem -Path $searchPath -Filter "${{ env.APPINSTALLER_FILENAME }}" -Recurse | Select-Object -First 1
          if ($appInstallerFile) {
            $appInstallerRelativePath = $appInstallerFile.FullName.Substring($searchPath.Length + 1).Replace('\', '/')
            echo "APPINSTALLER_PATH=$($appInstallerFile.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "APPINSTALLER_RELATIVE_PATH=$appInstallerRelativePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "AppInstaller relative path: $appInstallerRelativePath"
          } else {
            Write-Error "AppInstaller file not found"
            exit 1
          }
        shell: pwsh

      - name: Update AppInstaller with Release URL
        run: |
          [xml]$appInstallerXml = Get-Content "${{ env.APPINSTALLER_PATH }}"
          
          # 相対パスを使用してURLを構築
          $baseUrl = "${{ env.APPINSTALLER_URL }}"
          $msixUrl = "$baseUrl/${{ env.MSIX_BUNDLE_RELATIVE_PATH }}"
          $appInstallerUrl = "$baseUrl/${{ env.APPINSTALLER_RELATIVE_PATH }}"
          
          Write-Host "Updating AppInstaller Uri to: $appInstallerUrl"
          Write-Host "Updating MainBundle Uri to: $msixUrl"
          
          # AppInstaller自身のUriを更新
          $appInstallerXml.AppInstaller.Uri = $appInstallerUrl
          
          if ($appInstallerXml.AppInstaller.MainBundle) { $appInstallerXml.AppInstaller.MainBundle.Uri = $msixUrl }
          if ($appInstallerXml.AppInstaller.MainPackage) { $appInstallerXml.AppInstaller.MainPackage.Uri = $msixUrl }
          
          $appInstallerXml.Save("${{ env.APPINSTALLER_PATH }}")
          
          Write-Host "=== Updated .appinstaller content ==="
          Get-Content "${{ env.APPINSTALLER_PATH }}"
        shell: pwsh

      - name: Upload MSIX to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          prerelease: ${{ contains(env.RELEASE_TAG, '-') }}
          files: |
            ${{ env.MSIX_BUNDLE_PATH }}
            ${{ env.APPINSTALLER_PATH }}

      # 7. index.html を download.html にリネーム (docs/index.md との競合を回避)
      - name: Rename index.html to download.html
        if: ${{ !contains(github.ref_name, '-') }}
        run: |
          $outputPath = "${{ github.workspace }}\output"
          Write-Host "Searching for index.html files in $outputPath (recursive)..."
          
          $indexFiles = @(Get-ChildItem -Path $outputPath -Filter "index.html" -Recurse)
          
          if ($indexFiles.Count -eq 0) {
            Write-Error "No index.html files found in $outputPath or its subdirectories."
            exit 1
          }
          
          Write-Host "Found $($indexFiles.Count) index.html file(s)"
          foreach ($indexFile in $indexFiles) {
            $downloadPath = Join-Path $indexFile.DirectoryName "download.html"
            Write-Host "Renaming $($indexFile.FullName) to $downloadPath"
            Move-Item -Path $indexFile.FullName -Destination $downloadPath -Force
          }
          Write-Host "Successfully renamed all index.html files to download.html"
        shell: pwsh

      # 8. GitHub Pages (main/docs) にデプロイ
      - name: Deploy to GitHub Pages
        # プレリリース (ハイフン付きタグ) の場合は実行しない
        if: ${{ !contains(github.ref_name, '-') }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.workspace }}\output
          publish_branch: main
          destination_dir: docs
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: Deploy ${{ env.APPINSTALLER_FILENAME }} for ${{ env.RELEASE_TAG }}

      # 9. 証明書クリーンアップ
      - name: Cleanup Certificate
        if: always()
        run: Remove-Item -Path "${{ env.PFX_PATH }}" -Force
        shell: pwsh