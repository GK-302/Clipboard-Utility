name: Release MSIX & Jekyll Site

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: '手動指定バージョン (例: 1.2.1)'
        required: false
        default: ''

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==============================================================================
  # JOB 1: Windows環境でMSIXをビルドする
  # ==============================================================================
  build-msix:
    runs-on: windows-latest
    env:
      # プロジェクトパスなどは適宜調整してください
      SOLUTION_FILE: 'ClipboardUtility.sln'
      PACKAGE_PROJECT: 'ClipboardUtilityMSIXInstaller/ClipboardUtilityMSIXInstaller.wapproj'
      PACKAGE_MANIFEST: 'ClipboardUtilityMSIXInstaller/Package.appxmanifest'
      APPINSTALLER_FILENAME: 'ClipboardUtilityMSIXInstaller.appinstaller'
      # 生成されるWebページ等のURL
      APPINSTALLER_URL: 'https://gk-302.github.io/Clipboard-Utility'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
          workloads: microsoft-net-sdk-windowsdesktop

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # --- ライセンス生成ツールのインストール ---
      - name: Install License Tool
        run: dotnet tool install --global dotnet-project-licenses

      # --- 証明書のデコード ---
      - name: Decode PFX Certificate
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "signing_cert.pfx"
          [System.IO.File]::WriteAllBytes($pfxPath, [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}"))
          echo "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # --- バージョン設定 (重要: MSIX用に4桁化する) ---
      - name: Set Version
        run: |
          $inputVersion = "${{ github.event.inputs.version }}"
          $tagName = "${{ github.ref_name }}"
          
          # バージョン文字列の決定
          if ($inputVersion) { $baseVer = $inputVersion }
          elseif ($tagName -match '^v') { $baseVer = $tagName -replace '^v', '' -replace '-.*', '' }
          else { $baseVer = "0.0.1" }
          
          # 4桁に正規化 (例: 1.0.1 -> 1.0.1.0)
          $parts = $baseVer.Split('.')
          while ($parts.Count -lt 4) { $parts += "0" }
          $msixVersion = [string]::Join('.', $parts[0..3])
          
          Write-Host "Base Version: $baseVer"
          Write-Host "MSIX Version: $msixVersion"
          
          echo "PACKAGE_VERSION=$msixVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # --- ソリューションの復元 ---
      - name: Restore solution
        run: dotnet restore ${{ env.SOLUTION_FILE }} -r win-x64

      # --- ライセンス情報の生成 ---
      # フォルダがないとエラーになるため、事前に作成してから実行
      - name: Generate License Information
        run: |
          $licenseDir = "./ClipboardUtility/src/Assets"
          if (!(Test-Path $licenseDir)) {
              New-Item -ItemType Directory -Force -Path $licenseDir
          }
          dotnet-project-licenses -i ./ClipboardUtility/ClipboardUtility.csproj --outfile "$licenseDir/licenses.json" -j
        shell: pwsh

      # --- マニフェストのバージョン更新 ---
      - name: Update App Manifest Version
        run: |
          $manifestPath = "${{ github.workspace }}\${{ env.PACKAGE_MANIFEST }}"
          [xml]$xml = Get-Content $manifestPath
          $xml.Package.Identity.Version = "${{ env.PACKAGE_VERSION }}"
          $xml.Save($manifestPath)
        shell: pwsh

      # --- MSIXパッケージのビルド ---
      - name: Build MSIX Package
        run: |
          $outputPath = "${{ github.workspace }}\output"
          New-Item -ItemType Directory -Force -Path $outputPath
          
          # 注意: AppxPackageDirを指定しても、その下にバージョン付きフォルダが作られます
          msbuild ${{ env.PACKAGE_PROJECT }} /p:Configuration=Release `
            /p:Platform=x64 `
            /p:AppxPackageDir="$outputPath" `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="${{ env.PFX_PATH }}" `
            /p:PackageCertificatePassword="${{ secrets.PFX_PASSWORD }}" `
            /p:GenerateAppInstallerFile=true `
            /p:AppInstallerUri="${{ env.APPINSTALLER_URL }}" `
            /p:AppInstallerUpdateFrequency=0 `
            /p:AppInstallerShowPrompt=true `
            /p:AppxPackageBuildMode=SideloadOnly `
            /p:AppxBundle=Always `
            /p:AppInstallerMainBundlePath="${{ env.APPINSTALLER_FILENAME }}"
        shell: pwsh

      # --- アーティファクトのアップロード ---
      # outputフォルダごとアップロードします
      - name: Upload MSIX Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: msix-assets
          path: ${{ github.workspace }}\output

      - name: Cleanup Certificate
        if: always()
        run: Remove-Item -Path "${{ env.PFX_PATH }}" -Force
        shell: pwsh

  # ==============================================================================
  # JOB 2: Ubuntu環境でJekyllビルド & デプロイ
  # ==============================================================================
  deploy-site:
    needs: build-msix
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Source (for index.md / _config.yml)
        uses: actions/checkout@v4

      - name: Download MSIX Artifacts
        uses: actions/download-artifact@v4
        with:
          name: msix-assets
          path: ./msix_temp

      # --- ファイル整理とリネーム (重要) ---
      # msbuildの出力は階層が深いため、必要なファイルを見つけてルートに移動させます
      - name: Process MSIX Files (Flatten & Rename)
        run: |
          echo "Listing downloaded files:"
          ls -R ./msix_temp
          
          # .appinstaller ファイルを探し、そのディレクトリを特定する
          # (例: ./msix_temp/ClipboardUtility_1.0.1.0_Test/ClipboardUtility.appinstaller)
          APP_INSTALLER=$(find ./msix_temp -name "*.appinstaller" | head -n 1)
          
          if [ -z "$APP_INSTALLER" ]; then
            echo "Error: .appinstaller file not found!"
            exit 1
          fi

          SOURCE_DIR=$(dirname "$APP_INSTALLER")
          echo "Found artifacts in: $SOURCE_DIR"

          # index.html (App Installer Web Page) を download.html にリネームしてルートへ移動
          if [ -f "$SOURCE_DIR/index.html" ]; then
            echo "Renaming generated index.html to download.html..."
            cp "$SOURCE_DIR/index.html" ./download.html
            
            # 生成されたHTML内のリンクも修正 (index.html -> download.html)
            sed -i 's/index\.html/download\.html/g' ./download.html
          fi

          # その他のファイル (.appinstaller, .msixbundle, dependenciesなど) をルートにコピー
          # -n: 既存ファイル(index.mdなど)を上書きしないようにする (index.html以外)
          cp -rn "$SOURCE_DIR/"* .
          
          # 一時フォルダ削除
          rm -rf ./msix_temp

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4