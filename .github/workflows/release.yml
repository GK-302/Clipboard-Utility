name: Release App & Deploy Site

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

# 権限設定: ReleasesへのアップロードとPagesへのデプロイに必要
permissions:
  contents: write
  pages: write
  id-token: write

# 同時実行の制御 (Pagesデプロイ用)
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==============================================================================
  # JOB 1: アプリのビルド、署名、リリース作成 (Windows環境)
  # ==============================================================================
  build-windows-assets:
    runs-on: windows-latest
    env:
      # MSIX関連の設定
      PACKAGE_PROJECT: 'ClipboardUtilityMSIXInstaller/ClipboardUtilityMSIXInstaller.wapproj'
      APPINSTALLER_FILENAME: 'ClipboardUtilityMSIXInstaller.appinstaller'
      # Pagesの公開URL (Jekyllの構成に合わせて設定)
      APPINSTALLER_URL: 'https://gk-302.github.io/Clipboard-Utility'
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- セットアップ関連 ---
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            7.0.x
          workloads: microsoft-net-sdk-windowsdesktop

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install License Tool
        run: dotnet tool install --global dotnet-project-licenses

      # --- 証明書の準備 ---
      - name: Decode PFX Certificate
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "signing_cert.pfx"
          [System.IO.File]::WriteAllBytes($pfxPath, [System.Convert]::FromBase64String("${{ secrets.PFX_BASE64 }}"))
          echo "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # --- バージョン情報の抽出と設定 ---
      - name: Extract Version
        id: extract_version
        run: |
          $rawTag = "${{ github.ref_name }}"
          $version = $rawTag -replace '^v', '' -replace '-.*', ''
          $version4digit = "$version.0"
          
          echo "VERSION_NUMBER=$version" >> $env:GITHUB_OUTPUT
          echo "VERSION_4_DIGITS=$version4digit" >> $env:GITHUB_OUTPUT
          echo "RELEASE_TAG=$rawTag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      - name: Update Projects Version
        run: |
          $version = "${{ steps.extract_version.outputs.VERSION_4_DIGITS }}"
          
          # 1. Update csproj
          $csproj = "ClipboardUtility/ClipboardUtility.csproj"
          [xml]$xmlCs = Get-Content $csproj
          $node = $xmlCs.SelectSingleNode("//PropertyGroup/Version")
          if ($node) { $node.InnerText = $version; $xmlCs.Save($csproj) }

          # 2. Update appxmanifest (MSIX)
          $manifest = "ClipboardUtilityMSIXInstaller/Package.appxmanifest"
          [xml]$xmlMx = Get-Content $manifest
          $xmlMx.Package.Identity.Version = $version
          $xmlMx.Save($manifest)
        shell: pwsh

      # --- ビルド & ライセンス生成 ---
      - name: Restore & Generate License
        run: |
          dotnet restore ClipboardUtility.sln
          # ライセンス生成
          New-Item -ItemType Directory -Force -Path "./ClipboardUtility/src/Assets"
          dotnet-project-licenses -i ./ClipboardUtility/ClipboardUtility.csproj --outfile ./ClipboardUtility/src/Assets/licenses.json -j

      # --- 1. Standalone EXE ビルド ---
      - name: Publish WPF App (Standalone)
        run: |
          dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish ClipboardUtility/ClipboardUtility.csproj
          Copy-Item -Path ./ClipboardUtility/src/Assets/licenses.json -Destination ./publish/
          Copy-Item -Path ./README* -Destination ./publish/

      # --- 2. MSI インストーラービルド ---
      - name: Build MSI Installer
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\devenv.com" "ClipboardUtility.sln" /Build "Release|Any CPU" /Project "ClipboardUtilityInstaller"

      - name: Create NoAdmin MSI
        run: |
          New-Item -ItemType Directory -Force -Path "./ClipboardUtilityInstaller/Release-NoAdmin"
          Copy-Item -Path ./ClipboardUtilityInstaller/Release/* -Destination ./ClipboardUtilityInstaller/Release-NoAdmin/ -Recurse
          $sdkPath = (Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Filter "msiinfo.exe" -Recurse | Select-Object -First 1).FullName
          & $sdkPath "./ClipboardUtilityInstaller/Release-NoAdmin/ClipboardUtilityInstaller.msi" /W 10

      # --- 3. MSIX パッケージビルド ---
      - name: Build MSIX Package
        run: |
          $outputPath = "${{ github.workspace }}\msix_output"
          msbuild ${{ env.PACKAGE_PROJECT }} /p:Configuration=Release `
            /p:AppxPackageDir="$outputPath\" `
            /p:AppxPackageSigningEnabled=true `
            /p:PackageCertificateKeyFile="${{ env.PFX_PATH }}" `
            /p:PackageCertificatePassword="${{ secrets.PFX_PASSWORD }}" `
            /p:GenerateAppInstallerFile=true `
            /p:AppInstallerUri="${{ env.APPINSTALLER_URL }}" `
            /p:AppInstallerUpdateFrequency=0 `
            /p:AppInstallerShowPrompt=true `
            /p:ApplicationVersion="${{ steps.extract_version.outputs.VERSION_4_DIGITS }}" `
            /p:PackageVersion="${{ steps.extract_version.outputs.VERSION_4_DIGITS }}" `
            /p:UapAppxPackageBuildMode=SideloadOnly `
            /p:AppxBundle=Always `
            /p:AppInstallerMainBundlePath="${{ env.APPINSTALLER_FILENAME }}"
        shell: pwsh

      # --- MSIXの後処理 (パス修正とリネーム) ---
      - name: Fix MSIX Paths & Rename HTML
        run: |
          $searchPath = "${{ github.workspace }}\msix_output"
          $msixBundle = Get-ChildItem -Path $searchPath -Filter "*.msixbundle" -Recurse | Select-Object -First 1
          
          # フォルダ構成を特定 (通常は msix_output/ClipboardUtility..._Test/ の中にある)
          $packageFolder = $msixBundle.DirectoryName
          $folderName = $msixBundle.Directory.Name # 例: ClipboardUtilityMSIXInstaller_1.2.1.0_Test

          # 環境変数へパスを保存 (このフォルダ名がURLの一部になる)
          echo "MSIX_FOLDER_NAME=$folderName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "MSIX_FULL_PATH=$packageFolder" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # AppInstaller (.appinstaller) のパス修正
          $appInstaller = Get-ChildItem -Path $searchPath -Filter "${{ env.APPINSTALLER_FILENAME }}" -Recurse | Select-Object -First 1
          [xml]$xml = Get-Content $appInstaller.FullName
          
          # URLの組み立て: https://.../ClipboardUtility..._Test/setup.msixbundle
          $baseUrl = "${{ env.APPINSTALLER_URL }}"
          # MSIXバンドルのファイル名
          $bundleName = $msixBundle.Name
          
          # 重要: サイトのルートに「フォルダごと」置くため、URLは /フォルダ名/ファイル名 となる
          $newUrl = "$baseUrl/$folderName/$bundleName"
          $appInstallerUrl = "$baseUrl/$folderName/$($appInstaller.Name)"

          # XML書き換え
          $xml.AppInstaller.Uri = $appInstallerUrl
          if ($xml.AppInstaller.MainBundle) { $xml.AppInstaller.MainBundle.Uri = $newUrl }
          if ($xml.AppInstaller.MainPackage) { $xml.AppInstaller.MainPackage.Uri = $newUrl }
          $xml.Save($appInstaller.FullName)

          # index.html を download.html にリネーム (Jekyllのindexと競合しないように)
          $indexFile = Join-Path $packageFolder "index.html"
          if (Test-Path $indexFile) {
             Move-Item -Path $indexFile -Destination (Join-Path $packageFolder "download.html") -Force
          }
        shell: pwsh

      # --- アーティファクトの保存 (Job間の受け渡し用) ---
      # これが「Jekyllビルド」JobへMSIXフォルダを渡すための鍵です
      - name: Upload MSIX Artifact for Site Build
        uses: actions/upload-artifact@v4
        with:
          name: msix-package # Job 2 でこの名前でダウンロードする
          path: ${{ env.MSIX_FULL_PATH }}
          retention-days: 1

      # --- リリースへのアップロード (zip圧縮含む) ---
      - name: Zip Artifacts
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ClipboardUtility-Standalone-${{ env.RELEASE_TAG }}.zip
          Compress-Archive -Path ./ClipboardUtilityInstaller/Release/* -DestinationPath ClipboardUtility-Installer-${{ env.RELEASE_TAG }}.zip
          Compress-Archive -Path ./ClipboardUtilityInstaller/Release-NoAdmin/* -DestinationPath ClipboardUtility-Installer-NoAdmin-${{ env.RELEASE_TAG }}.zip

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          prerelease: ${{ contains(env.RELEASE_TAG, '-') }}
          files: |
            *.zip
            ${{ env.MSIX_FULL_PATH }}/*.msixbundle
            ${{ env.MSIX_FULL_PATH }}/*.appinstaller

      - name: Cleanup Certificate
        if: always()
        run: Remove-Item -Path "${{ env.PFX_PATH }}" -Force
        shell: pwsh

  # ==============================================================================
  # JOB 2: Jekyllサイトのビルド (Ubuntu環境)
  # ==============================================================================
  build-site:
    needs: build-windows-assets # Windowsでのビルドが終わってから実行
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      # Windows Jobで作ったMSIXフォルダをダウンロード
      - name: Download MSIX Artifact
        uses: actions/download-artifact@v4
        with:
          name: msix-package
          # 一時フォルダに保存
          path: ./temp_msix_assets

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      # 【重要】Jekyllのビルド結果(_site)の中に、MSIXフォルダを移動させる
      # これにより、サイトの一部としてMSIXファイルが配信されます
      # フォルダ名は Artifactの中身から動的に決定するか、固定名にするか調整可能
      # ここではダウンロードした中身を、適切なフォルダ名で配置します
      - name: Inject MSIX into Site
        run: |
          # フォルダ名を特定 (例: ClipboardUtilityMSIXInstaller_1.2.1.0_Test)
          # temp_msix_assetsの中身を _site/ の中へ移動
          
          # 注: Windows側でフォルダ名を環境変数で渡すのが難しいので、
          # ここでは一意な名前(元のフォルダ名)を探して移動します
          DIR_NAME=$(ls ./temp_msix_assets | head -n 1)
          echo "Injecting MSIX folder: $DIR_NAME"
          
          # _siteの中に移動
          mv ./temp_msix_assets ./_site/$DIR_NAME

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  # ==============================================================================
  # JOB 3: デプロイ (GitHub Pages)
  # ==============================================================================
  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-site
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4