name: .NET WPF Release with Licenses

# ==================================================
# ワークフローが実行されるタイミング
# ==================================================
on:
  push:
    tags:
      - "v*.*.*" # 例: v0.1.2, v0.1.2-beta
  workflow_dispatch:

jobs:
  build-and-release:
    name: Build, Generate License, and Release
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      # 1. チェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. .NET SDKをセットアップする
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # プロジェクト本体用の8.0と、ツール用の7.0を両方インストール
          dotnet-version: |
            8.0.x
            7.0.x
          workloads: microsoft-net-sdk-windowsdesktop

      # 3. MSBuild セットアップ
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # --- [追加] ライセンス生成ツールのインストール ---
      - name: Install License Tool
        run: dotnet tool install --global dotnet-project-licenses

      # 4. NuGet パッケージの復元
      - name: Restore NuGet packages
        run: dotnet restore ClipboardUtility.sln

      # --- [修正] ライセンス情報の生成 ---
      # インストーラープロジェクトが参照しているパス(src/Assets/licenses.json)へ生成して上書きします。
      # これにより、後続のMSIビルド時に自動的にファイルが取り込まれます。
      - name: Generate License Information
        run: |
          # 念のためディレクトリが存在するか確認し、なければ作成
          New-Item -ItemType Directory -Force -Path "./ClipboardUtility/src/Assets"
          
          # ライセンス生成実行 (入力プロジェクトと出力先を明示的に指定)
          dotnet-project-licenses -i ./ClipboardUtility/ClipboardUtility.csproj --outfile ./ClipboardUtility/src/Assets/licenses.json -j

      # 4a. バージョン番号の抽出
      - name: Extract version number from tag
        id: extract_version
        run: |
          $VERSION_NUMBER = "${{ github.ref_name }}" -replace '^v', '' -replace '-.*', ''
          Write-Host "Extracted version: $VERSION_NUMBER"
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $env:GITHUB_OUTPUT

      # 4b. インストーラーバージョンの検証
      - name: Compare Tag Version with Installer Version
        run: |
          $TAG_VERSION = "${{ steps.extract_version.outputs.VERSION_NUMBER }}"
          $VDPROJ_PATH = "ClipboardUtilityInstaller/ClipboardUtilityInstaller.vdproj"
          $FILE_CONTENT = Get-Content $VDPROJ_PATH
          $FILE_VERSION_LINE = $FILE_CONTENT | Select-String -Pattern '("ProductVersion" = "8:)([\d\.]+)"'

          if (-not $FILE_VERSION_LINE) {
            Write-Error "Could not find 'ProductVersion' in $VDPROJ_PATH"
            exit 1
          }

          $FILE_VERSION = $FILE_VERSION_LINE.Matches.Groups[2].Value
          
          if ($TAG_VERSION -ne $FILE_VERSION) {
            Write-Error "Tag version ($TAG_VERSION) does not match installer version ($FILE_VERSION)."
            exit 1
          }
          Write-Host "Versions match. Proceeding."

      # 4c. csprojのバージョン更新
      - name: Update .csproj Version Tag
        run: |
          $CSPROJ_PATH = "ClipboardUtility/ClipboardUtility.csproj"
          $TAG_VERSION = "${{ steps.extract_version.outputs.VERSION_NUMBER }}"
          $VERSION_4_DIGITS = "$TAG_VERSION.0"
          
          [xml]$csproj = Get-Content -Path $CSPROJ_PATH
          $versionNode = $csproj.SelectSingleNode("//PropertyGroup/Version")
          
          if ($versionNode -eq $null) {
            Write-Error "<Version> tag not found in $CSPROJ_PATH"
            exit 1
          }
          
          $versionNode.InnerText = $VERSION_4_DIGITS
          $csproj.Save($CSPROJ_PATH)

      # 5. WPFアプリケーションの発行 (単一exe)
      - name: Publish WPF Application
        run: dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish ClipboardUtility/ClipboardUtility.csproj

      # --- [修正] ライセンスファイルを単一exe用フォルダへコピー ---
      # 生成場所が変わったので、新しいパスからコピーします
      - name: Copy License to publish folder
        run: Copy-Item -Path ./ClipboardUtility/src/Assets/licenses.json -Destination ./publish/

      # 6. MSIインストーラーのビルド
      # ここで .vdproj は "./ClipboardUtility/src/Assets/licenses.json" を参照し、
      # インストーラー内部にパッケージングします。
      - name: Build MSI Installer
        run: |
          & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\devenv.com" "ClipboardUtility.sln" /Build "Release|Any CPU" /Project "ClipboardUtilityInstaller"
          
          if (Test-Path "ide_activity.log") {
            Get-Content "ide_activity.log" -Encoding UTF8 -ErrorAction SilentlyContinue
          }

      # 7. NoAdmin版インストーラーの作成とUAC解除
      # MSIの中にライセンスファイルが含まれているため、MSIをコピー・改造するだけでOK
      - name: Create and Modify NoAdmin Installer Version
        run: |
          New-Item -ItemType Directory -Force -Path "./ClipboardUtilityInstaller/Release-NoAdmin"
          Copy-Item -Path ./ClipboardUtilityInstaller/Release/* -Destination ./ClipboardUtilityInstaller/Release-NoAdmin/ -Recurse

          $sdkPath = (Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Filter "msiinfo.exe" -Recurse | Sort-Object FullName -Descending | Select-Object -First 1).FullName
          $msiPath = "./ClipboardUtilityInstaller/Release-NoAdmin/ClipboardUtilityInstaller.msi"
          
          & $sdkPath $msiPath /W 10

      # 8. READMEのコピー
      - name: Copy README to publish folder
        run: Copy-Item -Path ./README* -Destination ./publish/

      # 9. 単一exe版のZIP圧縮
      - name: Zip the standalone artifact
        run: Compress-Archive -Path ./publish/* -DestinationPath ClipboardUtility-Standalone-${{ github.ref_name }}.zip

      # 10. 通常版インストーラーのZIP圧縮
      - name: Zip the normal installer artifact
        run: Compress-Archive -Path ./ClipboardUtilityInstaller/Release/* -DestinationPath ClipboardUtility-Installer-${{ github.ref_name }}.zip

      # 11. NoAdmin版インストーラーのZIP圧縮
      - name: Zip the no-admin installer artifact
        run: Compress-Archive -Path ./ClipboardUtilityInstaller/Release-NoAdmin/* -DestinationPath ClipboardUtility-Installer-NoAdmin-${{ github.ref_name }}.zip

      # 12. GitHubリリース作成
      - name: Create or Update Release with MSI/EXE assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            ./ClipboardUtility-Standalone-${{ github.ref_name }}.zip
            ./ClipboardUtility-Installer-${{ github.ref_name }}.zip
            ./ClipboardUtility-Installer-NoAdmin-${{ github.ref_name }}.zip