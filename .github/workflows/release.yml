# ワークフローの名前
name: .NET WPF Release

# ワークフローが実行されるタイミングを定義
on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*'

  workflow_dispatch:

# 実行される一連のタスク（ジョブ）を定義
jobs:
  build-and-release:
    # ジョブの名前
    name: Build and Release
    # 実行環境を指定。WPFはWindowsが必須
    runs-on: windows-latest

    steps:
      # 1. リポジトリのソースコードをチェックアウトする
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. .NET SDKをセットアップする
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # プロジェクトで使用している.NETのバージョンを指定
          dotnet-version: '8.0.x' 

      # 3. プロジェクトをビルドし、発行（publish）する
      - name: Publish Project
        run: dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish ClipboardUtility/ClipboardUtility.csproj
        # --configuration Release: リリースモードでビルド
        # --runtime win-x64: 64bitのWindows向けにビルド
        # --self-contained true: .NETがインストールされていなくても動くように自己完結型でビルド
        # -p:PublishSingleFile=true: 関連ファイルを含んだ単一の.exeファイルとして出力
        # -o ./publish: 'publish'という名前のフォルダに出力

      # 4. 発行された成果物をZIPファイルに圧縮する
      - name: Zip the artifacts
        run: Compress-Archive -Path ./publish/* -DestinationPath ClipboardUtility-v${{ github.ref_name }}.zip

      # 5. GitHubリリースを作成する
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # トークンは自動で設定されます
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      # 6. ZIPファイルをリリースにアップロードする
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # 5で作成したリリースのURL
          asset_path: ./ClipboardUtility-v${{ github.ref_name }}.zip # 4で作成したZIPファイルのパス
          asset_name: ClipboardUtility-v${{ github.ref_name }}.zip # リリースに表示されるファイル名
          asset_content_type: application/zip
