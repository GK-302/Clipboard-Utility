# ワークフローの名前
name: .NET WPF Release

# ワークフローが実行されるタイミングを定義
on:
  push:
    tags:
      - 'v*.*.*'

  workflow_dispatch:

# 実行される一連のタスク（ジョブ）を定義
jobs:
  build-and-release:
    # ジョブの名前
    name: Build and Release
    # 実行環境を指定。WPFはWindowsが必須
    runs-on: windows-latest

    # GitHubリリースを作成・編集するために、リポジトリのコンテンツへの書き込み権限を付与します。
    permissions:
      contents: write

    steps:
      # 1. リポジトリのソースコードをチェックアウトする
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. .NET SDKをセットアップする
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # プロジェクトで使用している.NETのバージョンを指定
          dotnet-version: '8.0.x'

      # 3a. 【単一ファイル版】プロジェクトを発行（publish）する
      - name: Publish Standalone Project
        run: dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -o ./publish-standalone ClipboardUtility/ClipboardUtility.csproj
        # --configuration Release: リリースモードでビルド
        # --runtime win-x64: 64bitのWindows向けにビルド
        # --self-contained true: .NETがインストールされていなくても動くように自己完結型でビルド
        # -p:PublishSingleFile=true: 関連ファイルを含んだ単一の.exeファイルとして出力
        # -o ./publish-standalone: 'publish-standalone'という名前のフォルダに出力

# 3b. バージョン情報を解析し、プレリリースか判定する
      - name: Parse Version Information
        id: version_info
        shell: pwsh
        run: |
          $tagName = "${{ github.ref_name }}"
          $isPrerelease = $false
          $baseVersion = $tagName.Substring(1) # 'v'を削除

          # ハイフンが含まれているかチェック
          if ($tagName.Contains("-")) {
            $isPrerelease = $true
            # ハイフンより前の部分だけを取り出す -> '1.2.3-beta.1' -> '1.2.3'
            $baseVersion = $baseVersion.Split("-")[0]
          }
          
          # バージョンを '.' で分割
          $versionParts = [System.Collections.Generic.List[string]]@($baseVersion.Split('.'))
          
          # バージョンが4つの部分になるまで '0' を追加
          while ($versionParts.Count -lt 4) {
            $versionParts.Add('0')
          }
          
          # 配列を '.' で結合して完全なバージョン番号を作成
          $fullVersion = $versionParts -join '.'
          
          # 後続のステップで使えるように結果を出力変数に設定
          Write-Host "Tag: $tagName"
          Write-Host "Is Prerelease: $isPrerelease"
          Write-Host "Full Version: $fullVersion"
          echo "is_prerelease=$isPrerelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "full_version=$fullVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # 3c. 【ClickOnce版】プロジェクトを発行（publish）する
      - name: Publish ClickOnce Installer
        shell: pwsh
        run: |
          $fullVersion = "${{ steps.version_info.outputs.full_version }}"
          dotnet publish --configuration Release --runtime win-x64 `
            -p:PublishProtocol=ClickOnce `
            -p:ApplicationVersion=$fullVersion `
            -p:AssemblyVersion=$fullVersion `
            -p:GenerateManifests=True `
            -p:SignManifests=false `
            -o ./publish-clickonce `
            ClipboardUtility/ClipboardUtility.csproj

      # 4. README.mdを単一ファイル版のpublishディレクトリにコピーする
      - name: Copy README to standalone publish folder
        run: Copy-Item -Path ./README* -Destination ./publish-standalone/

      # 5a. 【単一ファイル版】発行された成果物をZIPファイルに圧縮する
      - name: Zip the standalone artifacts
        run: Compress-Archive -Path ./publish-standalone/* -DestinationPath ClipboardUtility-Standalone-${{ github.ref_name }}.zip

      # 5b. 【ClickOnce版】発行された成果物をZIPファイルに圧縮する
      - name: Zip the ClickOnce installer
        run: Compress-Archive -Path ./publish-clickonce/* -DestinationPath ClipboardUtility-ClickOnce-Installer-${{ github.ref_name }}.zip

# 6. GitHubリリースを作成する
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          # version_infoステップの結果を使ってプレリリースかどうかを動的に設定
          prerelease: ${{ steps.version_info.outputs.is_prerelease }}

      # 7a. 【単一ファイル版】ZIPファイルをリリースにアップロードする
      - name: Upload Standalone Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ClipboardUtility-Standalone-${{ github.ref_name }}.zip
          asset_name: ClipboardUtility-Standalone-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      # 7b. 【ClickOnce版】ZIPファイルをリリースにアップロードする
      - name: Upload ClickOnce Installer Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ClipboardUtility-ClickOnce-Installer-${{ github.ref_name }}.zip
          asset_name: ClipboardUtility-ClickOnce-Installer-${{ github.ref_name }}.zip
          asset_content_type: application/zip
